<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Sistem Kasir & Inventaris Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --success: #27ae60; --danger: #e74c3c; --warning: #f1c40f; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; background: #f4f7f6; }
        .sidebar { width: 380px; background: var(--primary); color: white; padding: 20px; overflow-y: auto; }
        .main { flex: 1; padding: 20px; overflow-y: auto; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; color: #333; }
        input, button { padding: 10px; width: 100%; border-radius: 5px; border: 1px solid #ddd; margin-bottom: 8px; box-sizing: border-box; }
        button { cursor: pointer; font-weight: bold; border: none; color: white; transition: 0.3s; }
        .btn-green { background: var(--success); } .btn-blue { background: var(--accent); } .btn-red { background: var(--danger); }
        table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 10px; }
        th, td { padding: 8px; border-bottom: 1px solid #eee; text-align: left; }
        th { background: #f8f9fa; }
        .total-display { font-size: 2.5em; text-align: right; color: var(--danger); font-weight: bold; }
        .log-section { margin-top: 20px; border-top: 2px solid #555; padding-top: 10px; }
        #interactive.viewport { width: 100%; height: 150px; background: #000; border-radius: 8px; overflow: hidden; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="sidebar">
    <h3>ðŸ“¦ Manajemen Stok (Masuk)</h3>
    <input type="text" id="db-bc" placeholder="Barcode (Opsional)">
    <input type="text" id="db-nm" placeholder="Nama Barang">
    <input type="number" id="db-hg" placeholder="Harga Jual">
    <input type="number" id="db-st" placeholder="Jumlah Tambah Stok">
    <button class="btn-green" onclick="simpanStokMasuk()">Simpan & Catat Barang Masuk</button>
    
    <div class="log-section">
        <h4>ðŸ“‹ Ringkasan Stok Saat Ini</h4>
        <div id="view-stok" style="font-size: 12px; max-height: 150px; overflow-y: auto;"></div>
    </div>

    <div class="log-section">
        <h4>ðŸ“Š Download Laporan</h4>
        <button class="btn-blue" onclick="exportLaporanStok()">Laporan Stok (In/Out)</button>
        <button class="btn-blue" style="background:#8e44ad; margin-top:5px;" onclick="exportPenjualan()">Laporan Penjualan</button>
    </div>
</div>

<div class="main">
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2>ðŸ›’ Kasir Penjualan (Barang Keluar)</h2>
            <input type="text" id="scan-input" style="width: 300px;" placeholder="Cari Nama / Scan Barcode..." onchange="prosesInput(this.value)">
        </div>
        <div id="interactive" class="viewport"></div>
        <button class="btn-blue" style="width: auto; padding: 5px 15px;" onclick="startScanner()">Nyalakan Kamera</button>

        <table>
            <thead>
                <tr><th>Barang</th><th>Harga</th><th>Qty</th><th>Subtotal</th><th>Aksi</th></tr>
            </thead>
            <tbody id="cart-table"></tbody>
        </table>
        <div class="total-display" id="total-tagihan">Rp 0</div>
    </div>

    <div class="card">
        <div style="display: flex; gap: 15px; align-items: center;">
            <input type="number" id="bayar-input" placeholder="Uang Bayar" style="font-size: 1.5em;" oninput="hitungKembali()">
            <div id="val-kembali" style="font-size: 1.5em; font-weight: bold; flex: 1;">Kembali: Rp 0</div>
            <button class="btn-green" style="height: 50px; width: 200px;" onclick="prosesTransaksi()">BAYAR & CATAT</button>
        </div>
    </div>
</div>

<script>
    let dbProduk = JSON.parse(localStorage.getItem('dbProduk')) || {};
    let logInventaris = JSON.parse(localStorage.getItem('logInventaris')) || [];
    let logPenjualan = JSON.parse(localStorage.getItem('logPenjualan')) || [];
    let cart = [];

    // --- MANAJEMEN BARANG MASUK ---
    function simpanStokMasuk() {
        const bc = document.getElementById('db-bc').value || 'ID-' + Date.now();
        const nm = document.getElementById('db-nm').value;
        const hg = parseInt(document.getElementById('db-hg').value);
        const st = parseInt(document.getElementById('db-st').value) || 0;

        if(!nm || isNaN(hg)) return alert("Nama dan Harga wajib diisi!");

        // Update Database
        if(dbProduk[bc]) {
            dbProduk[bc].stok += st;
            dbProduk[bc].harga = hg; // Update harga jika berubah
        } else {
            dbProduk[bc] = { nama: nm, harga: hg, stok: st };
        }

        // Catat di Log Inventaris (MASUK)
        logInventaris.push({
            waktu: new Date().toLocaleString(),
            barcode: bc,
            nama: nm,
            tipe: "MASUK",
            jumlah: st,
            sisa_stok: dbProduk[bc].stok
        });

        localStorage.setItem('dbProduk', JSON.stringify(dbProduk));
        localStorage.setItem('logInventaris', JSON.stringify(logInventaris));
        
        alert(`Stok ${nm} berhasil ditambahkan!`);
        renderViewStok();
        ['db-bc', 'db-nm', 'db-hg', 'db-st'].forEach(id => document.getElementById(id).value = '');
    }

    function renderViewStok() {
        const view = document.getElementById('view-stok');
        view.innerHTML = "";
        for (let bc in dbProduk) {
            let p = dbProduk[bc];
            view.innerHTML += `<div style="border-bottom:1px solid #555; padding:3px 0;">${p.nama} | <b>Stok: ${p.stok}</b></div>`;
        }
    }

    // --- KASIR (BARANG KELUAR) ---
    function prosesInput(val) {
        if(dbProduk[val]) {
            tambahKeCart(val);
        } else {
            // Cari berdasarkan nama jika bukan barcode
            for (let bc in dbProduk) {
                if (dbProduk[bc].nama.toLowerCase() === val.toLowerCase()) {
                    tambahKeCart(bc);
                    break;
                }
            }
        }
        document.getElementById('scan-input').value = '';
    }

    function tambahKeCart(bc) {
        const p = dbProduk[bc];
        if (p.stok <= 0) return alert("Stok Habis!");
        const item = cart.find(i => i.barcode === bc);
        if (item) {
            if (item.qty + 1 > p.stok) return alert("Stok tidak cukup!");
            item.qty++; item.total = item.qty * item.harga;
        } else {
            cart.push({ barcode: bc, nama: p.nama, harga: p.harga, qty: 1, total: p.harga });
        }
        renderCart();
    }

    function renderCart() {
        const tbody = document.getElementById('cart-table');
        tbody.innerHTML = '';
        let total = 0;
        cart.forEach((i, idx) => {
            total += i.total;
            tbody.innerHTML += `<tr><td>${i.nama}</td><td>${i.harga.toLocaleString()}</td><td>${i.qty}</td><td>${i.total.toLocaleString()}</td><td><button class="btn-red" style="padding:2px 5px" onclick="cart.splice(${idx},1);renderCart()">X</button></td></tr>`;
        });
        document.getElementById('total-tagihan').innerText = "Rp " + total.toLocaleString('id-ID');
    }

    function hitungKembali() {
        const total = parseInt(document.getElementById('total-tagihan').innerText.replace(/\D/g,''));
        const bayar = parseInt(document.getElementById('bayar-input').value) || 0;
        document.getElementById('val-kembali').innerText = "Kembali: Rp " + (bayar - total).toLocaleString('id-ID');
    }

    function prosesTransaksi() {
        if(cart.length === 0) return;
        const totalFinal = document.getElementById('total-tagihan').innerText;

        cart.forEach(item => {
            // Potong Stok di DB
            dbProduk[item.barcode].stok -= item.qty;

            // Catat di Log Inventaris (KELUAR)
            logInventaris.push({
                waktu: new Date().toLocaleString(),
                barcode: item.barcode,
                nama: item.nama,
                tipe: "KELUAR (JUAL)",
                jumlah: item.qty,
                sisa_stok: dbProduk[item.barcode].stok
            });
        });

        logPenjualan.push({ waktu: new Date().toLocaleString(), total: totalFinal, item: cart.length });
        
        localStorage.setItem('dbProduk', JSON.stringify(dbProduk));
        localStorage.setItem('logInventaris', JSON.stringify(logInventaris));
        localStorage.setItem('logPenjualan', JSON.stringify(logPenjualan));

        alert("Transaksi Berhasil & Stok Berkurang!");
        location.reload();
    }

    // --- EXPORT LAPORAN ---
    function exportLaporanStok() {
        const ws = XLSX.utils.json_to_sheet(logInventaris);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Mutasi Stok");
        XLSX.writeFile(wb, "Laporan_Masuk_Keluar_Stok.xlsx");
    }

    function exportPenjualan() {
        const ws = XLSX.utils.json_to_sheet(logPenjualan);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Penjualan");
        XLSX.writeFile(wb, "Laporan_Penjualan.xlsx");
    }

    function startScanner() {
        Quagga.init({ inputStream: { name: "Live", type: "LiveStream", target: document.querySelector('#interactive') }, decoder: { readers: ["ean_reader", "code_128_reader"] } }, function() { Quagga.start(); });
        Quagga.onDetected(function(res) { tambahKeCart(res.codeResult.code); Quagga.stop(); setTimeout(startScanner, 1500); });
    }

    renderViewStok();
</script>
</body>
</html>
